<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="./resources/ol.css">
        <link rel="stylesheet" href="resources/fontawesome-all.min.css">
        <link href="resources/photon-geocoder-autocomplete.min.css" rel="stylesheet">
        <link rel="stylesheet" href="./resources/ol-layerswitcher.css">
        <link rel="stylesheet" href="./resources/qgis2web.css">
        <style>
        html, body {
            background-color: #ffffff;
        }
        .ol-control > * {
            background-color: #f8f8f8!important;
            color: #444444!important;
            border-radius: 0px;
        }
        .ol-attribution a, .gcd-gl-input::placeholder, .search-layer-input-search::placeholder {
            color: #444444!important;
        }
        .search-layer-input-search {
            background-color: #f8f8f8!important;
        }
        .ol-control > *:focus, .ol-control >*:hover {
            background-color: rgba(248, 248, 248, 0.7)!important;
        } 
        .ol-control {
            background-color: rgba(255,255,255,.4) !important;
            padding: 2px !important;
        } 

        body, html {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        #main-wrapper {
            display: flex;
            flex-direction: row;
            height: 100vh;
            width: 100vw;
        }

        #left-pane {
            width: 270px;
            background: #23272f;
            color: #fff;
            height: 100vh;
            box-shadow: 2px 0 8px rgba(34,34,34,0.04);
            display: flex;
            flex-direction: column;
            padding: 0;
            z-index: 10;
        }
        .sidebar-header {
            font-size: 2rem;
            font-weight: 700;
            text-align: left;
            padding: 2.2rem 2rem 1rem 2rem;
            letter-spacing: 0.5px;
            border-bottom: none;
            color: #fafafa;
        }
        .sidebar-header span {
            border-bottom: 3px solid #24b2ff;
            padding-bottom: 0.3rem;
            color: #24b2ff;
            font-size: 1.6rem;
            display: inline-block;
            letter-spacing:1px;
        }
        .sidebar-header.flood-header {
            /* Same as .sidebar-header but separate class for Flood Extent */
            font-size: 2rem;
            font-weight: 700;
            text-align: left;
            padding: 2.2rem 2rem 1rem 2rem;
            letter-spacing: 0.5px;
            border-bottom: none;
            color: #fafafa;
        }
        .sidebar-header.flood-header span {
            border-bottom: 3px solid #f39c12;
            padding-bottom: 0.3rem;
            color: #f39c12;
            font-size: 1.6rem;
            display: inline-block;
            letter-spacing:1px;
        }
        .nav-bar {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 2rem;
            padding: 0 1.4rem;
        }
        .nav-btn {
            display: flex;
            align-items: center;
            gap: 1.2rem;
            padding: 1rem 1.2rem;
            font-size: 1.17rem;
            font-weight: 600;
            border: none;
            outline: none;
            background: none;
            color: #fafafa;
            transition: background 0.18s, color 0.18s;
            border-radius: 10px;
            cursor: pointer;
            letter-spacing: 1px;
        }
        .nav-btn i {
            font-size: 1.5rem;
        }
        .nav-btn:hover, .nav-btn.active {
            background: #24b2ff;
            color: #fff;
        }
        /* Flood hazard section style */
        .flood-section {
            margin-top: 2.5rem;
        }
        .flood-form-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            margin: 0 2rem 1.4rem 2rem;
        }
        .flood-form-label {
            font-size: 1.03rem;
            color: #f39c12;
            font-weight: 600;
            margin-bottom: 0.35rem;
            margin-left: 2px;
            letter-spacing: 0.5px;
        }
        .flood-modern-select {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 8px;
            background: #262a33;
            color: #fafafa;
            font-size: 1.08rem;
            font-weight: 500;
            outline: none;
            transition: background 0.14s;
            min-width: 135px;
            box-shadow: 0 0 0 1px #222326;
        }
        .flood-modern-select:focus {
            background: #181b1f;
            box-shadow: 0 0 0 1.5px #f39c12;
        }
        .flood-divider {
            border: none;
            border-top: 2px solid #444;
            margin: 1.2rem 2rem 0.5rem 2rem;
        }
        
        /* Flood Legend Styles */
        .flood-legend-section {
            margin: 1.5rem 2rem 1rem 2rem;
        }
        .flood-legend {
            background: #262a33;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 0.5rem;
            border: 1px solid #333;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 0.6rem;
            padding: 0.3rem 0;
        }
        .legend-item:last-child {
            margin-bottom: 0;
        }
        .legend-icon {
            width: 20px;
            height: 20px;
            border-radius: 2px;
            flex-shrink: 0;
        }
        .legend-text {
            color: #fafafa;
            font-size: 0.95rem;
            font-weight: 500;
        }

        /* Top Pane Styles */
        #top-pane {
            position: fixed;
            left: 270px;
            top: 0;
            right: 0;
            height: 72px;
            background: #23272f;
            color: #fafafa;
            display: flex;
            align-items: center;
            z-index: 9;
            box-shadow: 0 2px 8px rgba(34,34,34,0.04);
            padding-left: 2.5rem;
            padding-right: 3rem;
        }
        .search-form {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            width: 100%;
            max-width: 600px;
            margin-left: 0;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .form-label {
            font-size: 1.03rem;
            color: #24b2ff;
            font-weight: 600;
            margin-bottom: 0.35rem;
            margin-left: 2px;
            letter-spacing: 0.5px;
        }
        .modern-select {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 8px;
            background: #262a33;
            color: #fafafa;
            font-size: 1.08rem;
            font-weight: 500;
            outline: none;
            transition: background 0.14s;
            min-width: 135px;
            box-shadow: 0 0 0 1px #222326;
        }
        .modern-select:focus {
            background: #181b1f;
            box-shadow: 0 0 0 1.5px #24b2ff;
        }
        .search-btn {
            padding: 0.65rem 2.1rem;
            border: none;
            border-radius: 10px;
            background: #24b2ff;
            color: #fff;
            font-size: 1.13rem;
            font-weight: 700;
            letter-spacing: 1px;
            cursor: pointer;
            transition: background 0.12s, box-shadow 0.15s;
            margin-left: 1.4rem;
            box-shadow: 0 2px 8px rgba(36,178,255,0.09);
        }
        .search-btn:hover {
            background: #189fd1;
            box-shadow: 0 2px 14px rgba(36,178,255,0.13);
        }

        /* Modern Data Table for Household */
        #household-data-table-container {
            position: fixed;
            left: 270px;
            top: 72px;
            right: 0;
            z-index: 15;
            background: #fafcff;
            display: none;
            box-shadow: 0 2px 16px rgba(0,0,0,0.10), 0 0px 0px rgba(0,0,0,0);
            border-bottom: 1px solid #dde2ec;
            padding: 1.3rem 2.3rem 1.2rem 2.3rem;
        }
        @media only screen and (max-width: 700px) {
            #household-data-table-container { 
                left: 95px; 
                top: 60px; 
                padding: 0.5rem 0.6rem 0.6rem 0.6rem;
            }
        }
        .modern-table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 11px;
            overflow: hidden;
            font-size: 1.03rem;
            margin-top: 0;
            margin-bottom: 0;
            box-shadow: 0 2px 9px rgba(0,0,0,0.08);
        }
        .modern-table thead {
            background: #24b2ff;
            color: #fff;
        }
        .modern-table th, .modern-table td {
            padding: 0.82rem 1.15rem;
            text-align: left;
            border-bottom: 1px solid #dde2ec;
        }
        .modern-table th {
            font-weight: 700;
            font-size: 1.04rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .modern-table tr:last-child td {
            border-bottom: none;
        }
        .modern-table tbody tr:hover {
            background: #e6f4ff;
        }
        .modern-table .empty-message {
            text-align: center;
            font-style: italic;
            color: #aaa;
        }
        #close-household-table-btn {
            background: none;
            border: none;
            color: #777;
            font-size: 1.5rem;
            float: right;
            cursor: pointer;
            margin-top: -0.2rem;
            margin-right: -0.4rem;
            transition: color 0.18s;
        }
        #close-household-table-btn:hover {
            color: #24b2ff;
        }

        /* push map down to not overlap with top bar */
        #map-container {
            flex: 1 1 0%;
            height: calc(100vh - 72px);
            width: 100%;
            position: relative;
            overflow: hidden;
            margin-top: 72px;
        }
        #map {
            width: 100%;
            height: 100%;
            margin: 0;
        }

        @media only screen and (max-width: 700px) {

            #left-pane { width: 95px; }
            #top-pane { left: 95px; height: 60px; padding-left: 1rem; }
            .sidebar-header, .sidebar-header.flood-header { font-size: 1.15rem; padding: 1.2rem 1rem 1rem 1rem; }
            .nav-btn { font-size: 0.9rem; padding: 0.8rem 0.5rem; }
            .nav-btn span { display: none; }
            .nav-btn i { font-size: 1.35rem; }
            .nav-bar { padding: 0 0.4rem; }
            .form-label, .flood-form-label { font-size: 0.91rem; }
            .modern-select, .flood-modern-select { font-size: 0.98rem; padding: 0.5rem 0.8rem;}
            .search-btn { padding: 0.5rem 1.1rem; font-size: 1rem; margin-left: 0.5rem;}
            .search-form { gap: 0.6rem; }
            .flood-section { margin-top: 1.2rem; }
            .flood-form-group { margin: 0 1rem 1rem 1rem; }
            .flood-divider { margin: 1rem 1rem 0.5rem 1rem; }
            .flood-legend-section { margin: 1rem 1rem 0.8rem 1rem; }
            .flood-legend { padding: 0.8rem; }
            .legend-item { gap: 0.6rem; margin-bottom: 0.5rem; }
            .legend-icon { width: 16px; height: 16px; }
            .legend-text { font-size: 0.9rem; }
        }
        </style>

        <title>PROJECT TOMAS</title>
    </head>
    <body>
        <div id="main-wrapper">
            <div id="left-pane">
                <div class="sidebar-header">
                    <span>Database</span>
                </div>
                <nav class="nav-bar">
                    <button class="nav-btn" id="household-btn" title="Household">
                        <i class="fas fa-home"></i>
                        <span>Household</span>
                    </button>
                    <button class="nav-btn" title="ACVs">
                        <i class="fas fa-industry"></i>
                        <span>ACVs</span>
                    </button>
                    <button class="nav-btn" title="Equipment">
                        <i class="fas fa-cogs"></i>
                        <span>Equipment</span>
                    </button>
                    <button class="nav-btn" id="roads-btn" title="Roads &amp; Bridges">
                        <i class="fas fa-road"></i>
                        <span>Roads &amp; Bridges</span>
                    </button>
                    <button class="nav-btn" title="Evac Center">
                        <i class="fas fa-hospital"></i>
                        <span>Evac Center</span>
                    </button>
                    <button class="nav-btn" title="Buildings">
                        <i class="fas fa-building"></i>
                        <span>Buildings</span>
                    </button>
                    <button class="nav-btn" title="Schools">
                        <i class="fas fa-school"></i>
                        <span>Schools</span>
                    </button>
                </nav>
                <!-- Flood Extent Dropdown Section Styled like Database Header -->
                <div class="flood-section">
                    <div class="sidebar-header flood-header">
                        <span>Flood Extent</span>
                    </div>
                    <div class="flood-form-group">
                        <label class="flood-form-label" for="floodExtentDropdown">Flood Extent</label>
                        <select id="floodExtentDropdown" class="flood-modern-select">
                            <option value="">Select Flood Extent</option>
                            <option value="24">24 meters</option>
                            <option value="25">25 meters</option>
                            <option value="26">26 meters</option>
                            <option value="27">27 meters</option>
                            <option value="28">28 meters</option>
                            <option value="29">29 meters</option>
                            <option value="30">30 meters</option>
                        </select>
                    </div>
                    <hr class="flood-divider" />
                    
                    <!-- Flood Extent Legend -->
                    <div class="flood-legend-section">
                        <div class="flood-form-label" style="font-size: 0.9em;">Legends (Flood Depth)</div>
                        <div class="flood-legend" style="display: flex; flex-direction: column; gap: 4px;">
                            <div class="legend-item" style="display: flex; align-items: center; gap: 6px;">
                                <img src="styles/legend/24_10_0.png" alt="0.0010" class="legend-icon" style="width: 18px; height: 18px; padding: 4px;" />
                                <span class="legend-text" style="font-size: 0.85em;">0.0010m</span>
                            </div>
                            <div class="legend-item" style="display: flex; align-items: center; gap: 6px;">
                                <img src="styles/legend/24_10_1.png" alt="2.3258" class="legend-icon" style="width: 18px; height: 18px; padding: 4px;" />
                                <span class="legend-text" style="font-size: 0.85em;">2.3258m</span>
                            </div>
                            <div class="legend-item" style="display: flex; align-items: center; gap: 6px;">
                                <img src="styles/legend/24_10_2.png" alt="4.6505" class="legend-icon" style="width: 18px; height: 18px; padding: 4px;" />
                                <span class="legend-text" style="font-size: 0.85em;">4.6505m</span>
                            </div>
                            <div class="legend-item" style="display: flex; align-items: center; gap: 6px;">
                                <img src="styles/legend/24_10_3.png" alt="6.9753" class="legend-icon" style="width: 18px; height: 18px; padding: 4px;" />
                                <span class="legend-text" style="font-size: 0.85em;">6.9753m</span>
                            </div>
                            <div class="legend-item" style="display: flex; align-items: center; gap: 6px;">
                                <img src="styles/legend/24_10_4.png" alt="9.3000" class="legend-icon" style="width: 18px; height: 18px; padding: 4px;" />
                                <span class="legend-text" style="font-size: 0.85em;">9.3000m</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Top Bar -->
            <div id="top-pane">
                <form class="search-form" autocomplete="off">
                    <div class="form-group">
                        <label class="form-label" for="province-select">Province</label>
                        <select id="province-select" class="modern-select">
                            <option value="">Select Province</option>
                        <!-- INSERT_YOUR_CODE -->
                        <script>
                        // Dynamically populate province-select from Barangay_1.js NAME_1
                        // Assumes Barangay_1.js exposes a global variable 'json_Barangay_1'
                        (function() {
                            // Wait for DOM to be ready
                            document.addEventListener("DOMContentLoaded", function() {
                                // Check if json_Barangay_1 exists
                                if (typeof json_Barangay_1 !== "undefined" && json_Barangay_1.features) {
                                    // Extract NAME_1, unique only
                                    var provincesSet = new Set();
                                    json_Barangay_1.features.forEach(function(feature) {
                                        if (feature.properties && feature.properties.NAME_1) {
                                            provincesSet.add(feature.properties.NAME_1);
                                        }
                                    });
                                    var provinces = Array.from(provincesSet).sort();
                                    var provinceSelect = document.getElementById('province-select');
                                    provinces.forEach(function(province) {
                                        var opt = document.createElement('option');
                                        opt.value = province;
                                        opt.textContent = province;
                                        provinceSelect.appendChild(opt);
                                    });
                                }
                            });
                        })();
                        </script>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="municipality-select">Municipality</label>
                        <select id="municipality-select" class="modern-select">
                            <option value="">Select Municipality</option>
                            <script>
                            // Dynamically populate municipality-select from Barangay_1.js NAME_2
                            // Assumes Barangay_1.js exposes a global variable 'json_Barangay_1'
                            (function() {
                                document.addEventListener("DOMContentLoaded", function() {
                                    var provinceSelect = document.getElementById('province-select');
                                    var municipalitySelect = document.getElementById('municipality-select');

                                    // Function to update municipality options based on selected province
                                    function updateMunicipalityOptions() {
                                        // Remove all options except the first ("Select Municipality")
                                        while (municipalitySelect.options.length > 1) {
                                            municipalitySelect.remove(1);
                                        }
                                        var selectedProvince = provinceSelect.value;

                                        if (
                                            typeof json_Barangay_1 !== "undefined" &&
                                            json_Barangay_1.features &&
                                            selectedProvince
                                        ) {
                                            var municipalitiesSet = new Set();
                                            json_Barangay_1.features.forEach(function(feature) {
                                                if (
                                                    feature.properties &&
                                                    feature.properties.NAME_1 === selectedProvince &&
                                                    feature.properties.NAME_2
                                                ) {
                                                    municipalitiesSet.add(feature.properties.NAME_2);
                                                }
                                            });
                                            var municipalities = Array.from(municipalitiesSet).sort();
                                            municipalities.forEach(function(municipality) {
                                                var opt = document.createElement('option');
                                                opt.value = municipality;
                                                opt.textContent = municipality;
                                                municipalitySelect.appendChild(opt);
                                            });
                                        }
                                    }

                                    // Populate municipalities initially only if province is already selected
                                    if (provinceSelect.value) {
                                        updateMunicipalityOptions();
                                    }

                                    // Update municipalities whenever province changes
                                    provinceSelect.addEventListener('change', updateMunicipalityOptions);
                                });
                            })();
                            </script>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="barangay-select">Barangay</label>
                        <select id="barangay-select" class="modern-select">
                            <option value="">Select Barangay</option>
                        <script>
                        // Dynamically populate barangay-select from Barangay_1.js NAME_3
                        // Assumes Barangay_1.js exposes a global variable 'json_Barangay_1'
                        (function() {
                            // Function to update barangay options when municipality (and province) changes
                            function updateBarangayOptions() {
                                var provinceSelect = document.getElementById('province-select');
                                var municipalitySelect = document.getElementById('municipality-select');
                                var barangaySelect = document.getElementById('barangay-select');
                                
                                // Remove all options except the first ("Select Barangay")
                                while (barangaySelect.options.length > 1) {
                                    barangaySelect.remove(1);
                                }

                                var selectedProvince = provinceSelect.value;
                                var selectedMunicipality = municipalitySelect.value;

                                if (
                                    typeof json_Barangay_1 !== "undefined" &&
                                    json_Barangay_1.features &&
                                    selectedProvince &&
                                    selectedMunicipality
                                ) {
                                    var barangaysSet = new Set();
                                    json_Barangay_1.features.forEach(function(feature) {
                                        if (
                                            feature.properties &&
                                            feature.properties.NAME_1 === selectedProvince &&
                                            feature.properties.NAME_2 === selectedMunicipality &&
                                            feature.properties.NAME_3
                                        ) {
                                            barangaysSet.add(feature.properties.NAME_3);
                                        }
                                    });
                                    var barangays = Array.from(barangaysSet).sort();
                                    barangays.forEach(function(barangay) {
                                        var opt = document.createElement('option');
                                        opt.value = barangay;
                                        opt.textContent = barangay;
                                        barangaySelect.appendChild(opt);
                                    });
                                }
                            }

                            document.addEventListener("DOMContentLoaded", function() {
                                var municipalitySelect = document.getElementById('municipality-select');
                                var provinceSelect = document.getElementById('province-select');
                                
                                // Populate barangays initially if both are selected
                                if (provinceSelect.value && municipalitySelect.value) {
                                    updateBarangayOptions();
                                }

                                // Update barangay options whenever province or municipality changes
                                provinceSelect.addEventListener('change', updateBarangayOptions);
                                municipalitySelect.addEventListener('change', updateBarangayOptions);
                            });
                        })();
                        </script>
                        </select>
                    </div>
                    <button type="button" class="search-btn" id="zoom-barangay-btn">Search</button>
                <script>
                document.getElementById('zoom-barangay-btn').addEventListener('click', function() {
                    var province = document.getElementById('province-select').value;
                    var municipality = document.getElementById('municipality-select').value;
                    var barangay = document.getElementById('barangay-select').value;

                    // Make sure the OpenLayers map variable is in scope as "map" and vector layer as "jsonSource_Barangay_1"
                    if (typeof map !== 'undefined' && typeof json_Barangay_1 !== 'undefined' && json_Barangay_1.features) {
                        var format = new ol.format.GeoJSON();
                        var features = format.readFeatures(json_Barangay_1, {
                            featureProjection: map.getView().getProjection()
                        });

                        // Find the feature matching all three criteria
                        var foundFeature = features.find(function(feature) {
                            var prop = feature.getProperties();
                            return prop.NAME_1 === province && prop.NAME_2 === municipality && prop.NAME_3 === barangay;
                        });

                        if (foundFeature) {
                            var extent = foundFeature.getGeometry().getExtent();
                            map.getView().fit(extent, {
                                duration: 1000,
                                maxZoom: 17 // Set a reasonable max zoom
                            });

                            // Pin and label logic
                            // Remove previous temporary pin layer if it exists
                            if (window.barangayPinLayer) {
                                map.removeLayer(window.barangayPinLayer);
                                window.barangayPinLayer = null;
                            }
                            // Get the center of the polygon (in map projection)
                            var center = ol.extent.getCenter(extent);

                            // Create pin style (a simple marker: red circle)
                            var pinStyle = new ol.style.Style({
                                image: new ol.style.Circle({
                                    radius: 8,
                                    fill: new ol.style.Fill({ color: 'red' }),
                                    stroke: new ol.style.Stroke({ color: 'white', width: 2 })
                                }),
                                text: new ol.style.Text({
                                    text: barangay,
                                    offsetY: -18,
                                    font: 'bold 15px sans-serif',
                                    fill: new ol.style.Fill({ color: '#222' }),
                                    stroke: new ol.style.Stroke({ color: '#fff', width: 3 })
                                })
                            });

                            var pinFeature = new ol.Feature({
                                geometry: new ol.geom.Point(center)
                            });
                            pinFeature.setStyle(pinStyle);

                            // Add to new vector layer for pin+label
                            window.barangayPinLayer = new ol.layer.Vector({
                                source: new ol.source.Vector({
                                    features: [pinFeature]
                                }),
                                zIndex: 9999
                            });
                            map.addLayer(window.barangayPinLayer);

                        } else {
                            alert("Barangay not found.");
                        }
                    }
                });
                </script>
                    
                </form>
            </div>

            <!-- Modern Table Container for Household Data (initially hidden) -->
            <div id="household-data-table-container">
                <button id="close-household-table-btn" title="Close Table">&times;</button>
                <table class="modern-table" id="household-data-table">
                    <thead>
                        <tr>
                            <th>Given Name</th>
                           <th>Middle Name</th>
                            <th>Last Name</th>
                            <th>Household Size</th>
                            <th>Age</th>
                            <th>Sex</th>
                            <th>Occupation</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="empty-message" colspan="6">No household selected.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div id="map-container">
                <div id="map">
                    <div id="popup" class="ol-popup">
                        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
                        <div id="popup-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <script src="resources/qgis2web_expressions.js"></script>
        <script src="./resources/functions.js"></script>
        <script src="./resources/ol.js"></script>
        <script src="./resources/ol-layerswitcher.js"></script>
        <script src="resources/photon-geocoder-autocomplete.min.js"></script>
        <script src="layers/Barangay_1.js"></script>
        <script src="layers/Municipality_2.js"></script>
        <script src="layers/Province_3.js"></script>
        <script src="layers/Households_11.js"></script>
        <script src="layers/Roads_12.js"></script>
        <script src="styles/Barangay_1_style.js"></script>
        <script src="styles/Municipality_2_style.js"></script>
        <script src="styles/Province_3_style.js"></script>
        <script src="styles/Households_11_style.js"></script>
        <script src="styles/Roads_12_style.js"></script>
        <script src="./layers/layers.js" type="text/javascript"></script> 
        <script src="./resources/Autolinker.min.js"></script>
        <script src="./resources/qgis2web.js"></script>
        <script>
        // Wait for Province_3 features to load before attempting to access them.
        // The variable 'json_Province_3_0' is defined in Province_3.js and holds the GeoJSON FeatureCollection.

        // --- Hide Household and Roads polygons unless button is clicked ---.

        document.addEventListener("DOMContentLoaded", function () {

            // ========== Province Select Population ================
            function populateProvinceSelect() {
                // Try to access the variable from Province_3.js
                if (typeof json_Province_3_0 === "undefined" || !json_Province_3_0.features) {
                    setTimeout(populateProvinceSelect, 100);
                    return;
                }
                var features = json_Province_3_0.features;
                var provinceNames = [];
                features.forEach(function (feature) {
                    if (feature.properties && feature.properties.NAME_1) {
                        var provinceName = feature.properties.NAME_1.trim();
                        if (provinceNames.indexOf(provinceName) === -1 && provinceName.length > 0) {
                            provinceNames.push(provinceName);
                        }
                    }
                });
                provinceNames.sort();
                var provinceSelect = document.getElementById('province-select');
                if (!provinceSelect) return;
                while (provinceSelect.options.length > 1) {
                    provinceSelect.remove(1);
                }
                provinceNames.forEach(function (name) {
                    var option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    provinceSelect.appendChild(option);
                });
            }
            populateProvinceSelect();

            // ========== Household Polygon Visibility Control ============

            function setHouseholdInitialVisibility() {
                var householdLayer = null;
                if (typeof lyr_Households_11 !== "undefined") {
                    householdLayer = lyr_Households_11;
                } else if (typeof window !== "undefined") {
                    for (let k in window) {
                        if (
                            window.hasOwnProperty(k)
                            && typeof window[k] === 'object'
                            && window[k] !== null
                            && window[k].hasOwnProperty("setVisible")
                            && k.toLowerCase().indexOf("household") !== -1
                        ) {
                            householdLayer = window[k];
                            break;
                        }
                    }
                }

                if (!householdLayer) {
                    setTimeout(setHouseholdInitialVisibility, 150);
                    return;
                }

                if (typeof householdLayer.setVisible === "function") {
                    householdLayer.setVisible(false);
                }

                var householdBtn = document.getElementById('household-btn');
                if (!householdBtn) return;
                householdBtn.addEventListener('click', function() {
                    var isActive = this.classList.contains('active');
                    document.querySelectorAll('.nav-btn').forEach(function(btn){
                        btn.classList.remove('active');
                    });
                    if (!isActive) {
                        this.classList.add('active');
                        householdLayer.setVisible(true);
                    } else {
                        householdLayer.setVisible(false);
                    }
                });
            }

            setHouseholdInitialVisibility();

            // ========== Roads Layer Visibility Control ===========

            function setRoadsInitialVisibility() {
                var roadsLayer = null;
                if (typeof lyr_Roads_12 !== "undefined") {
                    roadsLayer = lyr_Roads_12;
                } else if (typeof window !== "undefined") {
                    for (let k in window) {
                        if (
                            window.hasOwnProperty(k)
                            && typeof window[k] === 'object'
                            && window[k] !== null
                            && window[k].hasOwnProperty("setVisible")
                            && k.toLowerCase().indexOf("road") !== -1
                        ) {
                            roadsLayer = window[k];
                            break;
                        }
                    }
                }

                if (!roadsLayer) {
                    setTimeout(setRoadsInitialVisibility, 150);
                    return;
                }

                if (typeof roadsLayer.setVisible === "function") {
                    roadsLayer.setVisible(false);
                }

                var roadsBtn = document.getElementById('roads-btn');
                if (!roadsBtn) return;
                roadsBtn.addEventListener('click', function() {
                    var isActive = this.classList.contains('active');
                    document.querySelectorAll('.nav-btn').forEach(function(btn){
                        btn.classList.remove('active');
                    });
                    if (!isActive) {
                        this.classList.add('active');
                        roadsLayer.setVisible(true);
                    } else {
                        roadsLayer.setVisible(false);
                    }
                });
            }

            setRoadsInitialVisibility();

            // ========== Flood Extent 24 meters (24_10.png) raster visibility ===========

            function findFloodExtent24Layer() {
                for (var key in window) {
                    if (
                        window.hasOwnProperty(key) &&
                        window[key] &&
                        typeof window[key] === "object" &&
                        window[key].hasOwnProperty("setVisible") &&
                        (
                            (window[key].getSource && window[key].getSource() && window[key].getSource().getUrl && typeof window[key].getSource().getUrl === "function" &&
                            (window[key].getSource().getUrl()+"").indexOf("24_10.png") !== -1) ||
                            (key.indexOf("24_10") !== -1)
                        )
                    ) {
                        return window[key];
                    }
                }
                return null;
            }

            function setFloodExtent24InitialVisibility() {
                var layer = findFloodExtent24Layer();
                if (!layer) {
                    setTimeout(setFloodExtent24InitialVisibility, 150);
                    return;
                }
                layer.setVisible(false);
                var dropdown = document.getElementById('flood-extent-select');
                if (!dropdown) return;
                dropdown.addEventListener('change', function(){
                    if(this.value === "24") {
                        layer.setVisible(true);
                    } else {
                        layer.setVisible(false);
                    }
                });
            }
            setFloodExtent24InitialVisibility();

            // =========================
            // ========== NEW: HOUSEHOLD POLYGON DATA TABLE ================
            // =========================

            // Utility: get OpenLayers map object (qgis2web puts it on 'map')
            function getMainMap() {
                if (typeof map !== "undefined") return map;
                if (typeof window !== "undefined" && window.map) return window.map;
                return null;
            }

            // Fields to display in the table:
            // Last name, Middle Name, household size, age, sex, Occupation.
            // Try typical spellings for field names from Household properties (adapt as needed)
            const householdTableFields = [
                { label: "Given Name",      field: ["GIVEN NAME", "LNAME", "lname", "last_name", "Last_Name", "lastName"] },
                { label: "Middle Name",    field: ["MIDDLE NAME", "MNAME", "mname", "middle_name", "Middle_Name", "middleName"] },
                { label: "Last Name",      field: ["LAST NAME", "LNAME", "lname", "last_name", "Last_Name", "lastName"] },
                { label: "Household Size", field: ["NUMBER OF OCCUPANTS", "SIZE", "household_size", "Household_Size", "HouseholdSize"] },
                { label: "Age",            field: ["AGE", "age"] },
                { label: "Sex",            field: ["SEX", "sex", "Sex"] },
                { label: "Occupation",     field: ["OCCUPATION", "occupation", "Occupation"] }
            ];

            // Handles multiple household member records (if properties includes arrays), but if not, just outputs a single row.
            function buildHouseholdTableRows(properties) {
                if (!properties) return `<tr><td class="empty-message" colspan="6">No household data found.</td></tr>`;
                // Check if any property is array: if so, per-member rows, else single-row household
                let maxLen = 1;
                const values = householdTableFields.map(f => {
                    let v = undefined;
                    for (let fname of f.field) if (v === undefined && properties.hasOwnProperty(fname)) v = properties[fname];
                    return v;
                });
                // If any value is array, get max array length for member records
                values.forEach(v => {
                    if (Array.isArray(v) && v.length > maxLen) maxLen = v.length;
                });

                let rows = "";
                for (let i = 0; i < maxLen; ++i) {
                    rows += "<tr>";
                    for (let j = 0; j < householdTableFields.length; ++j) {
                        const v = values[j];
                        let display;
                        if (Array.isArray(v)) {
                            display = (v[i] !== undefined && v[i] !== null) ? v[i] : "";
                        } else {
                            display = (i === 0 && v !== undefined && v !== null) ? v : "";
                        }
                        rows += `<td>${display !== undefined ? display : ""}</td>`;
                    }
                    rows += "</tr>";
                }

                // If all values are empty (all first row values are undefined/empty), return a 'no data' row.
                if (/^<tr>(<td>(|undefined|null)<\/td>)+<\/tr>$/.test(rows)) {
                    return `<tr><td class="empty-message" colspan="6">No household data found.</td></tr>`;
                }
                return rows;
            }

            // Show the data table with given properties (or hide if null)
            function showHouseholdDataTable(properties) {
                var container = document.getElementById("household-data-table-container");
                var tbody = document.getElementById("household-data-table").getElementsByTagName("tbody")[0];
                if (properties) {
                    tbody.innerHTML = buildHouseholdTableRows(properties);
                    container.style.display = "block";
                } else {
                    // No selection: message shown, hide
                    tbody.innerHTML = `<tr><td class="empty-message" colspan="6">No household selected.</td></tr>`;
                    container.style.display = "none";
                }
            }
            // Close button event
            document.getElementById("close-household-table-btn").addEventListener("click", function() {
                showHouseholdDataTable(null);
            });

            // ========== MAIN: Listen for household polygon selection ===========
            // - show table on select
            // - if map click, check if on a household, else hide table

            function setupHouseholdFeatureSelection() {
                const mapObj = getMainMap();
                if (!mapObj) {
                    setTimeout(setupHouseholdFeatureSelection, 150);
                    return;
                }
                let householdLayer = (typeof lyr_Households_11 !== "undefined") ? lyr_Households_11 : null;
                if (!householdLayer && typeof window !== "undefined") {
                    for (let k in window) {
                        if (
                            window.hasOwnProperty(k)
                            && typeof window[k] === 'object'
                            && window[k] !== null
                            && window[k].hasOwnProperty("getSource")
                            && k.toLowerCase().indexOf("household") !== -1
                        ) {
                            householdLayer = window[k];
                            break;
                        }
                    }
                }
                if (!householdLayer || typeof householdLayer.getSource !== "function") {
                    setTimeout(setupHouseholdFeatureSelection, 150);
                    return;
                }

                // OpenLayers vector layer
                // When household polygons are visible, click enables attribute table
                mapObj.on('singleclick', function(evt) {
                    // Disable default popup for household polygons.
                    let featureFound = null;
                    let isHouseholdFeature = false;

                    // Only active & visible if household layer is visible
                    if (!householdLayer.getVisible()) {
                        showHouseholdDataTable(null);
                        return;
                    }
                    // Get features at click location
                    mapObj.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
                        if (layer === householdLayer) {
                            featureFound = feature;
                            isHouseholdFeature = true;
                            return true;
                        }
                    });

                    if (isHouseholdFeature) {
                        // Suppress popup for household polygons
                        // Remove popup if open
                        var popupContainer = document.getElementById('popup');
                        if (popupContainer) popupContainer.style.display = 'none';

                        if (featureFound) {
                            showHouseholdDataTable(featureFound.getProperties());
                        } else {
                            showHouseholdDataTable(null);
                        }
                        // Prevent popup show from other handlers (if any)
                        evt.preventDefault && evt.preventDefault();
                        evt.stopPropagation && evt.stopPropagation();
                        return false;
                    }
                    // For non-household features, do not touch popup behavior here.

                });

                // Hide the table if any click outside household polygons (or on map when not visible)
                mapObj.getTargetElement().addEventListener('click', function(e){
                    // This is handled in 'singleclick' above! No need to double process.
                });

                // Also hide the table if layer is turned off
                if (typeof householdLayer.on === "function") {
                    householdLayer.on('change:visible', function(evt){
                        if (!householdLayer.getVisible()) showHouseholdDataTable(null);
                    });
                }
            }
            setupHouseholdFeatureSelection();

        });
        </script>
    </body>
</html>
